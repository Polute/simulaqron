<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Simulaci√≥n Cu√°ntica</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 2em;
        }
        .container-flex {
            display: flex;
            gap: 1em;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            max-width: none;
        }

        .columna-izquierda,
        .columna-centro,
        .columna-derecha {
            flex: 1;
            min-width: 0;
            background-color: white;
            padding: 1.5em;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .columna-izquierda {
            flex: 1.2;
            max-height: 90vh;
            overflow-y: auto;
        }
        .columna-centro {
            flex: 1.4;
        }
        .columna-derecha {
            flex: 1.5;
        }
        h1, h2 {
            color: #333;
        }
        .resultado, .estado, .contador {
            font-size: 1.2em;
            margin-top: 1em;
            padding: 1em;
            border-left: 5px solid;
        }
        .resultado { background-color: #e8f5e9; border-color: #4caf50; }
        .estado { background-color: #e3f2fd; border-color: #2196f3; }
        .contador { background-color: #fff3e0; border-color: #ff9800; }
        .boton {
            display: inline-block;
            margin-top: 1em;
            padding: 0.8em 1.5em;
            background-color: #2196f3;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .boton:hover { background-color: #1976d2; }
        #loading {
            display: none;
            margin-top: 1em;
            font-style: italic;
            color: #555;
        }
        .boton.activo {
            background-color: #1976d2;
        }

        #cuenta {
            font-size: 1em;
            margin-top: 0.5em;
            color: #777;
        }
        table {
            margin-top: 1em;
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 0.6em;
            border: 1px solid #ccc;
            text-align: center;
        }
        th { background-color: #eeeeee; }
        .param-input,
        .name-input {
            position: absolute;
            display: none;
            z-index: 10;
        }
        .label {
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .node {
            cursor: pointer;
        }
        .link {
            stroke: red;
            stroke-width: 2px;
        }
        #canvas {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: grab;
        }
        #tabla-nodos, #tabla-aristas {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            font-size: 0.9em;
        }
        #tabla-nodos th, #tabla-nodos td,
        #tabla-aristas th, #tabla-aristas td {
            border: 1px solid #ccc;
            padding: 0.4em;
            text-align: center;
        }
        #tabla-nodos input, #tabla-aristas input {
            width: 90%;
            padding: 0.2em;
            font-size: 0.9em;
        }
        .matrix-input {
            width: 40px;       /* ancho peque√±o */
            text-align: center; /* centrar el n√∫mero */
            padding: 2px;
            margin: 1px;
        }
    </style>
</head>
<body>
    <div class="container-flex">
        {% if rol == "alice" %}
        <!-- Columna izquierda: par√°metros f√≠sicos -->
        <div class="columna-izquierda">
            <h2>Editor de Mapa Cu√°ntico</h2>

            <div class="controles">
                <button id="modoNodo" class="boton">üñåÔ∏è Crear Nodos</button>
                <button id="modoArista" class="boton">üîó Crear Aristas</button>
                <label>pgen:</label>
                <input type="number" id="pgen" min="0" max="1" step="0.01" value="0.8">
                <button id="zoomIn" class="boton">‚ûï</button>
                <button id="zoomOut" class="boton">‚ûñ</button>
                <button id="resetView" class="boton">üìç</button>
            </div>

            <input type="number" id="paramInput" class="param-input" />
            <input type="text" id="nameInput" class="name-input" />

            <svg id="canvas"></svg>

            <h3>Par√°metros f√≠sicos</h3>
            <div style="display: flex; align-items: flex-start; gap: 40px;">
                <div>
                    <label for="pswap">pswap (0.0 - 1.0):</label>
                    <input type="number" id="pswap" name="pswap" min="0" max="1" step="0.01" value="0.9">
                </div>

                <div>
                    <label for="tipo_canal">Tipo de canal cu√°ntico:</label>
                    <select id="tipo_canal" onchange="toggleCanalInput()">
                        <option value="numero">N√∫mero (0‚Äì1)</option>
                        <option value="matriz">Matriz 4x4</option>
                    </select>

                    <!-- Input num√©rico -->
                    <div id="canal_numero">
                        <label for="canal_cuantico">Valor:</label>
                        <input type="number" id="canal_cuantico" name="canal_cuantico" min="0" max="1" step="0.01" value="1.0">
                    </div>

                    <!-- Matriz 4x4 -->
                    <div id="canal_matriz" style="display:none; margin-top:5px;">
                        <label>Canal cu√°ntico (matriz 4x4):</label>
                        <table style="border-collapse: collapse; margin-top: 5px;">
                        <tbody>
                            <tr>
                            <td><input type="number" step="0.01" id="m00" value="1.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m01" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m02" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m03" value="0.0" class="matrix-input"></td>
                            </tr>
                            <tr>
                            <td><input type="number" step="0.01" id="m10" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m11" value="1.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m12" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m13" value="0.0" class="matrix-input"></td>
                            </tr>
                            <tr>
                            <td><input type="number" step="0.01" id="m20" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m21" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m22" value="1.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m23" value="0.0" class="matrix-input"></td>
                            </tr>
                            <tr>
                            <td><input type="number" step="0.01" id="m30" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m31" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m32" value="0.0" class="matrix-input"></td>
                            <td><input type="number" step="0.01" id="m33" value="1.0" class="matrix-input"></td>
                            </tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <br><br>
            <h3>Nodos</h3>
            <table id="tabla-nodos">
                <thead>
                    <tr><th>ID</th><th>Nombre</th><th>pgen</th></tr>
                </thead>
                <tbody></tbody>
            </table>

            <h3>Aristas</h3>
            <table id="tabla-aristas">
                <thead>
                    <tr><th>Origen</th><th>Destino</th><th>Distancia (km)</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


        <!-- Columna central: simulaci√≥n -->
        <div class="columna-centro">
            <h1>Simulaci√≥n Cu√°ntica</h1>
            <p>Este experimento simula el env√≠o de <strong>2 qubits EPR</strong> desde Alice a Bob, con opci√≥n de entrelazamiento puro o con ruido (estado de Werner usando un nodo Repeater).</p>

            <div class="resultado" id="resultado">
                <strong>Resultado de la medici√≥n en Bob:</strong><br>
                {{ resultado }}
            </div>

            <div class="estado" id="estado">
                <strong>Estado:</strong> Esperando simulaci√≥n...
            </div>

            <div class="contador" id="contador">
                <strong>Simulaciones realizadas:</strong> {{ contador }}
            </div>

            <div id="loading">Ejecutando simulaci√≥n... por favor espera.</div>
            <div id="cuenta"></div>

            <div style="margin-top: 1em;">
                <label for="modo">Modo de env√≠o:</label>
                <select id="modo">
                    <option value="puro">Entrelazamiento puro (Alice ‚Üí Bob)</option>
                    <option value="werner">Entrelazamiento con ruido (Alice ‚Üí Bob)</option>
                    <option value="swap">Entanglement Swap (Alice ‚Üí Charlie ‚Üê‚Üí Bob)</option>
                </select>
            </div>
            <div style="margin-top: 1em; display: flex; align-items: center; gap: 1em;">
                <div>
                    <label for="num_ParesEPR">N√∫mero de pares generados:</label><br>
                    <input type="number" id="num_ParesEPR" name="num_ParesEPR" min="1" max="10" value="2">
                </div>

                <div>
                    <label for="modo_tiempo">Generaci√≥n:</label><br>
                    <select id="modo_tiempo" name="modo_tiempo">
                        <option value="secuencial">Secuencial</option>
                        <option value="simultaneo">Simult√°neo</option>
                    </select>
                    <div id="decoherenciaInfo" style="margin-top: 0.5em; color: #555; display: none;">
                        En modo <strong>simult√°neo</strong>, el tiempo de decoherencia de los pares EPR puede diferir debido a la computaci√≥n paralela.
                    </div>
                </div>
            </div>


            <button class="boton" onclick="iniciarSimulacion()">Iniciar Simulaci√≥n</button>
            <button class="boton" onclick="iniciarBucle()">Iniciar Bucle</button>
            <button class="boton" onclick="detenerBucle()">Detener Bucle</button>
        
        </div>
        {% endif %}
        <!-- Columna derecha: historial -->
        <div class="columna-derecha">
            <h2>Historial de Resultados</h2>
            <table id="tabla-resultados">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
            <button class="boton" onclick="limpiarHistorial()">Limpiar historial</button>
        </div>
    </div>

    <script>
        document.getElementById("modo_tiempo").addEventListener("change", function () {
            const info = document.getElementById("decoherenciaInfo");
            if (this.value === "simultaneo") {
                info.style.display = "block";
            } else {
                info.style.display = "none";
            }
        });
        document.getElementById("tipo_canal").addEventListener("change", function() {
            const tipo = this.value;
            document.getElementById("canal_numero").style.display = (tipo === "numero") ? "block" : "none";
            document.getElementById("canal_matriz").style.display = (tipo === "matriz") ? "block" : "none";
        });

    </script>
    <script>
        nodes = [
            { id: "Alice", name: "Alice", x: 100, y: 100, param: 0.8 },
            { id: "Bob", name: "Bob", x: 300, y: 100, param: 0.7 },
            { id: "Charlie", name: "Charlie", x: 200, y: 250, param: 0.9 }
        ];

        links = [
            { id: "dist_ab", source: nodes[0], target: nodes[1], length: 200, distanciaKm: 40 },
            { id: "dist_ac", source: nodes[0], target: nodes[2], length: 220, distanciaKm: 15 },
            { id: "dist_cb", source: nodes[2], target: nodes[1], length: 180, distanciaKm: 20 }
        ];


        //-----------------------------------------MAPA-----------------------------------------------
        window.onload = function () {
            const svg = document.getElementById("canvas");
            const paramInput = document.getElementById("paramInput");
            const nameInput = document.getElementById("nameInput");
            const pgenInput = document.getElementById("pgen");
            const modoNodoBtn = document.getElementById("modoNodo");
            const modoAristaBtn = document.getElementById("modoArista");
            const zoomInBtn = document.getElementById("zoomIn");
            const zoomOutBtn = document.getElementById("zoomOut");
            const resetViewBtn = document.getElementById("resetView");

            let modoNodo = false;
            let modoArista = false;
            let selectedNode = null, draggingNode = null, linkStart = null;
            let transform = { x: 0, y: 0, k: 1 };
            let draggingMap = false;
            let dragStart = { x: 0, y: 0 };

            // Llama al renderizado
            draw();


            modoNodoBtn.onclick = () => {
                modoNodo = !modoNodo;
                modoArista = false;
                modoNodoBtn.classList.toggle("activo", modoNodo);
                modoAristaBtn.classList.remove("activo");
            };

            modoAristaBtn.onclick = () => {
                modoArista = !modoArista;
                modoNodo = false;
                modoAristaBtn.classList.toggle("activo", modoArista);
                modoNodoBtn.classList.remove("activo");
            };

            zoomInBtn.onclick = () => {
                transform.k *= 1.1;
                draw();
            };

            zoomOutBtn.onclick = () => {
                transform.k *= 0.9;
                draw();
            };

            resetViewBtn.onclick = () => {
                transform = { x: 0, y: 0, k: 1 };
                draw();
            };

            function createNode(x, y) {
                const node = {
                    id: "Nodo_" + Date.now(),
                    name: "Nodo_" + Date.now(),
                    x, y,
                    param: parseFloat(pgenInput.value)
                };
                nodes.push(node);
                draw();
        }

        function createLink(source, target) {
            // Verificar si ya existe una arista entre estos dos nodos
            const existe = links.some(link =>
                (link.source === source && link.target === target) ||
                (link.source === target && link.target === source)
            );

            if (existe) return; // No crear duplicado

            const distanciaKm = 50;
            const length = Math.hypot(target.x - source.x, target.y - source.y);
            links.push({ source, target, length, distanciaKm });
            draw();
        }


        function draw() {
            svg.innerHTML = "";
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("transform", `translate(${transform.x},${transform.y}) scale(${transform.k})`);
            svg.appendChild(g);

            links.forEach(link => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", link.source.x);
                line.setAttribute("y1", link.source.y);
                line.setAttribute("x2", link.target.x);
                line.setAttribute("y2", link.target.y);
                line.setAttribute("class", "link");
                line.addEventListener("dblclick", () => {
                    const nueva = prompt("Distancia en km:", link.distanciaKm);
                    if (nueva !== null) {
                        link.distanciaKm = parseFloat(nueva);
                        draw();
                    }
                });
                g.appendChild(line);
            });

            nodes.forEach(node => {
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", node.x);
                circle.setAttribute("cy", node.y);
                circle.setAttribute("r", 20);
                circle.setAttribute("class", "node");
                circle.addEventListener("mousedown", e => {
                if (modoArista) {
                    if (linkStart && linkStart !== node) {
                        createLink(linkStart, node);
                        linkStart = null;
                    } else {
                        linkStart = node;
                    }
                } else {
                    draggingNode = node;
                }
            });

                g.appendChild(circle);

                const nameLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                nameLabel.setAttribute("x", node.x);
                nameLabel.setAttribute("y", node.y + 35);
                nameLabel.setAttribute("class", "label");
                nameLabel.textContent = node.name;
                nameLabel.addEventListener("dblclick", e => {
                    selectedNode = node;
                    nameInput.style.left = `${e.pageX}px`;
                    nameInput.style.top = `${e.pageY}px`;
                    nameInput.value = node.name;
                    nameInput.style.display = "block";
                    nameInput.focus();
                });
                g.appendChild(nameLabel);

                const paramLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                paramLabel.setAttribute("x", node.x);
                paramLabel.setAttribute("y", node.y + 50);
                paramLabel.setAttribute("class", "label");
                paramLabel.textContent = "pgen = " + node.param;
                paramLabel.addEventListener("dblclick", e => {
                    selectedNode = node;
                    paramInput.style.left = `${e.pageX}px`;
                    paramInput.style.top = `${e.pageY}px`;
                    paramInput.value = node.param;
                    paramInput.style.display = "block";
                    paramInput.focus();
                });
                g.appendChild(paramLabel);
            });

            actualizarTablaNodos();
            actualizarTablaAristas();
        }

        svg.addEventListener("click", e => {
            if (!modoNodo) return;
            const pt = getMousePosition(e);
            createNode(pt.x, pt.y);
        });

        svg.addEventListener("mousedown", e => {
            if (!modoNodo && !modoArista) {
                draggingMap = true;
                dragStart = { x: e.clientX, y: e.clientY };
            }
        });

        svg.addEventListener("mousemove", e => {
            if (draggingNode) {
                const pt = getMousePosition(e);
                draggingNode.x = pt.x;
                draggingNode.y = pt.y;
                draw();
            } else if (draggingMap) {
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                transform.x += dx;
                transform.y += dy;
                dragStart = { x: e.clientX, y: e.clientY };
                draw();
            }
        });

        svg.addEventListener("mouseup", () => {
            draggingNode = null;
            draggingMap = false;
        });

        svg.addEventListener("mouseleave", () => {
            draggingNode = null;
            draggingMap = false;
        });

        paramInput.addEventListener("change", () => {
            if (selectedNode) {
                selectedNode.param = parseFloat(paramInput.value);
                paramInput.style.display = "none";
                draw();
            }
        });

        nameInput.addEventListener("change", () => {
            if (selectedNode) {
                selectedNode.name = nameInput.value;
                selectedNode.id = nameInput.value;
                nameInput.style.display = "none";
                draw();
            }
        });

        function getMousePosition(e) {
            const rect = svg.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left - transform.x) / transform.k,
                y: (e.clientY - rect.top - transform.y) / transform.k
            };
        }

        function actualizarTablaNodos() {
            const tbody = document.querySelector("#tabla-nodos tbody");
            tbody.innerHTML = "";
            nodes.forEach((node, i) => {
                const fila = document.createElement("tr");

                const idCell = document.createElement("td");
                idCell.textContent = node.id;
                fila.appendChild(idCell);

                const nameCell = document.createElement("td");
                const nameInput = document.createElement("input");
                nameInput.value = node.name;
                nameInput.onchange = () => {
                    node.name = nameInput.value;
                    draw();
                };
                nameCell.appendChild(nameInput);
                fila.appendChild(nameCell);

                const pgenCell = document.createElement("td");
                const pgenInput = document.createElement("input");
                pgenInput.type = "number";
                pgenInput.step = "0.01";
                pgenInput.min = "0";
                pgenInput.max = "1";
                pgenInput.value = node.param;
                pgenInput.onchange = () => {
                    node.param = parseFloat(pgenInput.value);
                    draw();
                };
                pgenCell.appendChild(pgenInput);
                fila.appendChild(pgenCell);

                tbody.appendChild(fila);
            });
        }

        function actualizarTablaAristas() {
            const tbody = document.querySelector("#tabla-aristas tbody");
            tbody.innerHTML = "";
            links.forEach((link, i) => {
                const fila = document.createElement("tr");

                const origenCell = document.createElement("td");
                origenCell.textContent = link.source.name;
                fila.appendChild(origenCell);

                const destinoCell = document.createElement("td");
                destinoCell.textContent = link.target.name;
                fila.appendChild(destinoCell);

                const distCell = document.createElement("td");
                const distInput = document.createElement("input");
                distInput.type = "number";
                distInput.value = link.distanciaKm;
                distInput.onchange = () => {
                    link.distanciaKm = parseFloat(distInput.value);
                };
                distCell.appendChild(distInput);
                fila.appendChild(distCell);

                tbody.appendChild(fila);
            });
        }

        draw();
    };

        //-----------------------------------------SIMULACI√ìN------------
        let cuentaIntervalo;
        let segundos = 4;
        function getDistancia(id) {
            const link = links.find(l => l.id === id);
            return link ? link.distanciaKm : 0;
        }

        const nombres_nodos = nodes.map(n => n.id).join(" ");
        //fetch(`/crear_nodos_simulaqron?nodos=${nombres_nodos}`);

        function iniciarSimulacion() {
            const modo = document.getElementById("modo").value;
            const num_ParesEPR = document.getElementById("num_ParesEPR").value;
            console.log("Iniciando simulaci√≥n √∫nica");

            const dist_ab = getDistancia("dist_ab");
            const dist_ac = getDistancia("dist_ac");
            const dist_cb = getDistancia("dist_cb");

            const pgen = document.getElementById("pgen").value;
            const pswap = document.getElementById("pswap").value;
            const pgen_nodos = nodes.map(n => `${n.id}:${n.param}`).join(",");
            const distancias = links.map(l => `${l.source.id}:${l.target.id}:${l.distanciaKm}`).join(",");
            const modo_tiempo = document.getElementById("modo_tiempo").value;
            const canal_cuantico = getCanalCuantico();

            fetch(`/simular?modo=${modo}&num_ParesEPR=${num_ParesEPR}&pgen_nodos=${pgen_nodos}&distancias=${distancias}&pswap=${pswap}&modo_tiempo=${modo_tiempo}&canal_cuantico=${encodeURIComponent(canal_cuantico)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("resultado").innerHTML =
                        "<strong>Resultado de la medici√≥n en Bob:</strong><br>" + data.resultado;
                    document.getElementById("estado").innerHTML =
                        "<strong>Estado:</strong> Informaci√≥n enviada correctamente desde Alice a Bob.";
                    document.getElementById("contador").innerHTML =
                        "<strong>Simulaciones realizadas:</strong> " + data.contador;
                    actualizarTabla(data.historial);
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("cuenta").innerText = "";
                });
        }

        function iniciarBucle() {
        
            const modo = document.getElementById("modo").value;
            const num_ParesEPR = document.getElementById("num_ParesEPR").value;
            console.log("Comienza bucle de simulaci√≥n");

            document.getElementById("loading").style.display = "block";
            const dist_ab = document.getElementById("dist_ab").value;
            const dist_ac = document.getElementById("dist_ac").value;
            const dist_cb = document.getElementById("dist_cb").value;

            const pgen_nodos = nodes.map(n => `${n.id}:${n.param}`).join(",");
            const distancias = links.map(l => `${l.source.id}:${l.target.id}:${l.distanciaKm}`).join(",");
            const modo_tiempo = document.getElementById("modo_tiempo").value;
            const canal_cuantico = getCanalCuantico();
            fetch(`/simular?modo=${modo}&num_ParesEPR=${num_ParesEPR}&pgen_nodos=${pgen_nodos}&distancias=${distancias}&pswap=${pswap}&modo_tiempo=${modo_tiempo}&canal_cuantico=${encodeURIComponent(canal_cuantico)}`)
                .then(response => response.json())
                .then(data => {
                    mostrarResultado(data);

                    // Activar contador para siguientes simulaciones
                    segundos = 4;
                    actualizarCuenta();

                    cuentaIntervalo = setInterval(() => {
                        if (segundos > 0) {
                            segundos--;
                            actualizarCuenta();
                        } else {
                            // Detener contador visual y mostrar solo "Ejecutando..."
                            document.getElementById("cuenta").innerText = "";
                            document.getElementById("loading").style.display = "block";

                            // Lanzar siguiente simulaci√≥n
                            fetch(`/simular?modo=${modo}&num_ParesEPR=${num_ParesEPR}&dist_ab=${dist_ab}&dist_ac=${dist_ac}&dist_cb=${dist_cb}&pgen=${pgen}&pswap=${pswap}`)
                                .then(response => response.json())
                                .then(data => {
                                    mostrarResultado(data);
                                    //Si el resultado contiene "ERROR", detener el bucle
                                    if (data.resultado.includes("ERROR")) {
                                        detenerBucle();
                                        document.getElementById("estado").innerHTML =
                                            "<strong>Estado:</strong> Error detectado. Detenido el bucle. Limpia el historial.";
                                        return;
                                    }
                                    segundos = 4;
                                    actualizarCuenta();
                                });
                        }
                    }, 1000);
                });
        }

        function mostrarResultado(data) {
            document.getElementById("resultado").innerHTML =
                "<strong>Resultado de la medici√≥n en Bob:</strong><br>" + data.resultado;
            document.getElementById("estado").innerHTML =
                "<strong>Estado:</strong> Informaci√≥n enviada correctamente desde Alice a Bob.";
            document.getElementById("contador").innerHTML =
                "<strong>Simulaciones realizadas:</strong> " + data.contador;
            actualizarTabla(data.historial);
            document.getElementById("loading").style.display = "none";
        }

        function actualizarCuenta() {
            if (segundos > 0) {
                document.getElementById("cuenta").innerText =
                    "Pr√≥xima simulaci√≥n en: " + segundos + " segundos";
            } else {
                document.getElementById("cuenta").innerText = "";
            }
        }




        function detenerBucle() {
            console.log("Termina bucle de simulaci√≥n");
            clearInterval(cuentaIntervalo);
            document.getElementById("loading").style.display = "none";
            document.getElementById("cuenta").innerText = "";
        }

        function actualizarTabla(historial) {
            const tbody = document.querySelector("#tabla-resultados tbody");
            tbody.innerHTML = "";
            historial.forEach(linea => {
                const fila = document.createElement("tr");
                const partes = linea.split(":");
                fila.innerHTML = `<td>${partes[0].trim()}</td><td>${partes[1].trim()}</td>`;
                tbody.appendChild(fila);
            });
        }
        function limpiarHistorial() {
            fetch("/limpiar_historial")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("resultado").innerHTML =
                        "<strong>Resultado de la medici√≥n en Bob:</strong><br>Historial borrado.";
                    document.getElementById("estado").innerHTML =
                        "<strong>Estado:</strong> Historial limpiado correctamente.";
                    document.getElementById("contador").innerHTML =
                        "<strong>Simulaciones realizadas:</strong> 0";
                    actualizarTabla([]);
                });
        }
        let modoAnterior = document.getElementById("modo").value;

        document.getElementById("modo").addEventListener("change", () => {
            const nuevoModo = document.getElementById("modo").value;
            if (nuevoModo !== modoAnterior) {
                fetch("/limpieza_docs")
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "ok") {
                            document.getElementById("estado").innerHTML =
                                "<strong>Estado:</strong> Qubits limpiados al cambiar de modo.";
                            console.log("Qubits limpiados correctamente.");
                        } else {
                            document.getElementById("estado").innerHTML =
                                "<strong>Estado:</strong> Error al limpiar qubits.";
                            console.warn("Error al limpiar qubits.");
                        }
                        modoAnterior = nuevoModo;
                    });
            }
        });
        document.getElementById("num_ParesEPR").addEventListener("change", () => {
            const nuevoModo = document.getElementById("num_ParesEPR").value;
            if (nuevoModo !== modoAnterior) {
                fetch("/limpieza_docs")
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "ok") {
                            document.getElementById("estado").innerHTML =
                                "<strong>Estado:</strong> Qubits limpiados al cambiar de num_ParesEPR generados.";
                            console.log("Qubits limpiados correctamente.");
                        } else {
                            document.getElementById("estado").innerHTML =
                                "<strong>Estado:</strong> Error al limpiar qubits.";
                            console.warn("Error al limpiar qubits.");
                        }
                        modoAnterior = nuevoModo;
                    });
            }
        });

        function getCanalCuantico() {
            const tipo = document.getElementById("tipo_canal").value;
            if (tipo === "numero") {
                return document.getElementById("canal_cuantico").value;
            } else {
                const matrix = [];
                for (let i = 0; i < 4; i++) {
                    const row = [];
                    for (let j = 0; j < 4; j++) {
                        row.push(parseFloat(document.getElementById(`m${i}${j}`).value));
                    }
                    matrix.push(row);
                }
                return JSON.stringify(matrix);
            }
        }


    </script>
</body>
</html>
